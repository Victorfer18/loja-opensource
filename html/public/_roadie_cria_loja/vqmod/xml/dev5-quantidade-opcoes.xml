<?xml version="1.0" encoding="UTF-8"?>
<modification>
	<id>Quantidade x Opções</id>
	<version>2.1.x</version>
	<author>Dev5™</author>
	<link>https://dev5.com.br/</link>
	<file name="admin/controller/catalog/option.php">
		<operation error="log">
			<search position="replace"><![CDATA[$option['type'] == 'select']]></search>
			<add><![CDATA[$option['type'] == 'select' || $option['type'] == 'checkbox_qty' || $option['type'] == 'radio_qty' || $option['type'] == 'select_qty']]></add>
		</operation>
	</file>
	<!-- Admin : Catalog->Options -->
	<file name="admin/view/template/catalog/option_form.tpl">
		<operation error="log">
			<search position="before"><![CDATA[<optgroup label="<?php echo $text_choose; ?>">]]></search>
			<add><![CDATA[<optgroup label="<?php echo $text_choose; ?> com quantidade">
                <option value="select_qty"<?php if ($type == 'select_qty') { ?> selected<?php } ?>>Quantidade * Menu de seleção</option>
                <option value="radio_qty"<?php if ($type == 'radio_qty') { ?> selected<?php } ?>>Quantidade * Única seleção</option>
                <option value="checkbox_qty"<?php if ($type == 'checkbox_qty') { ?> selected<?php } ?>>Quantidade * Multipla seleção</option>
			</optgroup>]]></add>
		</operation>
		<operation error="log">
			<search position="replace"><![CDATA[this.value == 'select']]></search>
			<add><![CDATA[this.value == 'select' || this.value == 'checkbox_qty' || this.value == 'radio_qty' || this.value == 'select_qty']]></add>
		</operation>
	</file>
	<!-- Admin:Catalog->load->Option -->
	<file name="admin/view/template/catalog/product_form.tpl">
		<operation error="log">
			<search position="replace"><![CDATA[$product_option['type'] == 'select']]></search>
			<add><![CDATA[$product_option['type'] == 'select' || $product_option['type'] == 'checkbox_qty' || $product_option['type'] == 'radio_qty' || $product_option['type'] == 'select_qty']]></add>
		</operation>
		<operation error="log">
			<search position="replace"><![CDATA[item['type'] == 'select']]></search>
			<add><![CDATA[item['type'] == 'select' || item['type'] == 'checkbox_qty' || item['type'] == 'radio_qty' || item['type'] == 'select_qty']]></add>
		</operation>
	</file>
	<file name="admin/controller/catalog/product.php">
		<operation error="log">
			<search position="replace"><![CDATA[$product_option['type'] == 'select']]></search>
			<add><![CDATA[$product_option['type'] == 'select' || $product_option['type'] == 'checkbox_qty' || $product_option['type'] == 'radio_qty' || $product_option['type'] == 'select_qty']]></add>
		</operation>
		<operation error="log">
			<search position="replace"><![CDATA[$option_info['type'] == 'select']]></search>
			<add><![CDATA[$option_info['type'] == 'select' || $option_info['type'] == 'checkbox_qty' || $option_info['type'] == 'radio_qty' || $option_info['type'] == 'select_qty']]></add>
		</operation>
	</file>
	<file name="admin/model/catalog/product.php">
		<operation error="log">
			<search position="replace"><![CDATA[$product_option['type'] == 'select']]></search>
			<add><![CDATA[$product_option['type'] == 'select' || $product_option['type'] == 'checkbox_qty' || $product_option['type'] == 'radio_qty' || $product_option['type'] == 'select_qty']]></add>
		</operation>
	</file>
	<file name="system/library/cart.php">
		<operation error="log">
			<search position="before"><![CDATA[} elseif ($option_query->row['type'] == 'text' || $option_query->row['type'] == 'textarea' || $option_query->row['type'] == 'file' || $option_query->row['type'] == 'date' || $option_query->row['type'] == 'datetime' || $option_query->row['type'] == 'time') {]]></search>
			<add><![CDATA[} elseif ($option_query->row['type'] == 'radio_qty' || $option_query->row['type'] == 'select_qty') {  
          
                    $option_value_arr = explode('|', $value);
                    $product_option_value_id = $option_value_arr[0];
                    $option_value_quantity = $option_value_arr[1];
             
                    $option_value_query = $this->db->query("SELECT pov.option_value_id, ovd.name, pov.quantity, pov.subtract, pov.price, pov.price_prefix, pov.points, pov.points_prefix, pov.weight, pov.weight_prefix FROM " . DB_PREFIX . "product_option_value pov LEFT JOIN " . DB_PREFIX . "option_value ov ON (pov.option_value_id = ov.option_value_id) LEFT JOIN " . DB_PREFIX . "option_value_description ovd ON (ov.option_value_id = ovd.option_value_id) WHERE pov.product_option_value_id = '" . (int)$product_option_value_id . "' AND pov.product_option_id = '" . (int)$product_option_id . "' AND ovd.language_id = '" . (int)$this->config->get('config_language_id') . "'");
                      
                    if ( ($option_value_query->num_rows) && (!empty($option_value_quantity)) ) {                                                                                                                                               
                              
                              if ( !isset($option_price_with_quantity) ) 
                                $option_price_with_quantity = 0;
                              if ($option_value_query->row['price_prefix'] == '+') {
                                $option_price_with_quantity += $option_value_query->row['price'] * $option_value_quantity;
                              } else if ($option_value_query->row['price_prefix'] == '-') {
                                $option_price_with_quantity -= $option_value_query->row['price'] * $option_value_quantity;
                              }
                              
                              $subtract = $option_value_query->row['subtract'];
                              if ($subtract > 0) {
                                $subtract = $option_value_quantity;
                              }
                                                            
                             if ($subtract && (!$option_value_query->row['quantity'] || ($option_value_query->row['quantity'] < $cart['quantity']*$option_value_quantity))) {
											$stock = false;
										}

                              
                              $option_data[] = array(
                                      'product_option_id'       => $product_option_id,
                                      'product_option_value_id' => $product_option_value_id,
                                      'option_id'               => $option_query->row['option_id'],
                                      'option_value_id'         => $option_value_query->row['option_value_id'],
                                      'name'                    => $option_query->row['name'],
                                      'value'            		=> $option_value_query->row['name']." x ".$option_value_quantity,
                                      'type'                    => $option_query->row['type'],
                                      'quantity'                => $option_value_query->row['quantity'],
                                      'subtract'                => $subtract,
                                      'price'                   => $option_value_query->row['price'],
                                      'price_prefix'            => $option_value_query->row['price_prefix'],
                                      'points'                  => $option_value_query->row['points'],
                                      'points_prefix'           => $option_value_query->row['points_prefix'],
                                      'weight'                  => $option_value_query->row['weight'],
                                      'weight_prefix'           => $option_value_query->row['weight_prefix']
                              );                                                              
                      }
                      
          } elseif ($option_query->row['type'] == 'checkbox_qty') {                        
          
              foreach ($value as $product_option_value_id) {
                    if ( empty($product_option_value_id) )
                      continue;
              
                    $option_value_arr = explode('|', $product_option_value_id);
                    $product_option_value_id = $option_value_arr[0];
                    $option_value_quantity = $option_value_arr[1];
             
                    $option_value_query = $this->db->query("SELECT pov.option_value_id, ovd.name, pov.quantity, pov.subtract, pov.price, pov.price_prefix, pov.points, pov.points_prefix, pov.weight, pov.weight_prefix FROM " . DB_PREFIX . "product_option_value pov LEFT JOIN " . DB_PREFIX . "option_value ov ON (pov.option_value_id = ov.option_value_id) LEFT JOIN " . DB_PREFIX . "option_value_description ovd ON (ov.option_value_id = ovd.option_value_id) WHERE pov.product_option_value_id = '" . (int)$product_option_value_id . "' AND pov.product_option_id = '" . (int)$product_option_id . "' AND ovd.language_id = '" . (int)$this->config->get('config_language_id') . "'");
                      
                    if ( ($option_value_query->num_rows) && (!empty($option_value_quantity)) ) {                                                                                                                                               
                              
                              if ( !isset($option_price_with_quantity) ) 
                                $option_price_with_quantity = 0;
                              if ($option_value_query->row['price_prefix'] == '+') {
                                $option_price_with_quantity += $option_value_query->row['price'] * $option_value_quantity;
                              } else if ($option_value_query->row['price_prefix'] == '-') {
                                $option_price_with_quantity -= $option_value_query->row['price'] * $option_value_quantity;
                              }
                              
                              $subtract = $option_value_query->row['subtract'];
                              if ($subtract > 0) {
                                $subtract = $option_value_quantity;
                              }
                              
                             if ($subtract && (!$option_value_query->row['quantity'] || ($option_value_query->row['quantity'] < $cart['quantity']*$option_value_quantity))) {
											$stock = false;
										}

                              
                              $option_data[] = array(
                                      'product_option_id'       => $product_option_id,
                                      'product_option_value_id' => $product_option_value_id,
                                      'option_id'               => $option_query->row['option_id'],
                                      'option_value_id'         => $option_value_query->row['option_value_id'],
                                      'name'                    => $option_query->row['name'],
                                      'value'            		=> $option_value_query->row['name']." x ".$option_value_quantity,
                                      'type'                    => $option_query->row['type'],
                                      'quantity'                => $option_value_query->row['quantity'],
                                      'subtract'                => $subtract,
                                      'price'                   => $option_value_query->row['price'],
                                      'price_prefix'            => $option_value_query->row['price_prefix'],
                                      'points'                  => $option_value_query->row['points'],
                                      'points_prefix'           => $option_value_query->row['points_prefix'],
                                      'weight'                  => $option_value_query->row['weight'],
                                      'weight_prefix'           => $option_value_query->row['weight_prefix']
                              );                                                              
                      }
              }]]></add>
		</operation>
		<!-- OC 1.5.1.3 -->
		<operation error="log">
			<search position="before"><![CDATA[// Downloads]]></search>
			<!-- <search position="before"><![CDATA[if (!$product_query->row['quantity'] || ($product_query->row['quantity'] < $cart['quantity'])) {]]></search> -->
			<add><![CDATA[if ( isset($option_price_with_quantity) ) {
             $price += $option_price_with_quantity;
             unset($option_price_with_quantity);
           }]]></add>
		</operation>
	</file>
	<!-- Minus Quantity -->
	<file name="catalog/model/checkout/order.php">
		<operation error="log">
			<search position="replace"><![CDATA[$this->db->query("UPDATE " . DB_PREFIX . "product_option_value SET quantity = (quantity - " . (int)$order_product['quantity'] . ") WHERE product_option_value_id = '" . (int)$option['product_option_value_id'] . "' AND subtract = '1'");]]></search>
			<add><![CDATA[$this->db->query("UPDATE " . DB_PREFIX . "product_option_value SET quantity = (quantity - " . (int)$order_product['quantity'] * (int)$option['quantity'] . ") WHERE product_option_value_id = '" . (int)$option['product_option_value_id'] . "' AND subtract > '0'");]]></add>
		</operation>
		<operation error="log">
			<search position="before"><![CDATA[foreach ($data['products'] as $product) {]]></search>
			<add><![CDATA[$result_quantity = $this->db->query("SHOW COLUMNS FROM " . DB_PREFIX . "order_option LIKE 'quantity';");
        if ($result_quantity->num_rows == 0) {
            $this->db->query("ALTER TABLE " . DB_PREFIX . "order_option ADD COLUMN quantity int(4) NOT NULL DEFAULT 0;");                
        }]]></add>
		</operation>
		<operation error="log">
			<search position="replace"><![CDATA[order_option SET]]></search>
			<add><![CDATA[order_option SET quantity='".(int)$option['subtract']."',]]></add>
		</operation>
	</file>
	<file name="catalog/controller/checkout/confirm.php">
		<operation error="log">
			<search position="before"><![CDATA['option_value_id'         => $option['option_value_id'],]]></search>
			<add><![CDATA['subtract' => $option['subtract'],]]></add>
		</operation>
	</file>
	<file name="catalog/controller/checkout/simplecheckout.php" error="log">
		<operation error="log">
			<search position="before"><![CDATA['option_value_id'         => $option['option_value_id'],]]></search>
			<add><![CDATA['subtract' => $option['subtract'],]]></add>
		</operation>
	</file>
	<!-- Model -->
	<file name="catalog/model/catalog/product.php">
		<!-- FIX
    <operation error="log">
      <search position="replace"><![CDATA[$product_option['type'] == 'select']]></search>
      <add><![CDATA[$product_option['type'] == 'select' || $product_option['type'] == 'checkbox_qty' || $product_option['type'] == 'radio_qty' || $product_option['type'] == 'select_qty']]></add>
    </operation>
    -->
		<operation error="log">
			<search position="before"><![CDATA['weight'                  => $product_option_value['weight'],]]></search>
			<add><![CDATA['points'        => $product_option_value['points'],
          'points_prefix' => $product_option_value['points_prefix'],]]></add>
		</operation>
	</file>
	<file name="catalog/controller/product/product.php">
		<operation error="log">
			<search position="before"><![CDATA[$data['options'] = array();]]></search>
			<add><![CDATA[$data['price_value'] = $product_info['price'];
          $data['special_value'] = $product_info['special'];
          $data['tax_value'] = (float)$product_info['special'] ? $product_info['special'] : $product_info['price'];
          
          $var_currency = array();
          $var_currency['value'] = ($this->currency->getValue() ? $this->currency->getValue() : 1);
          $var_currency['symbol_left'] = $this->currency->getSymbolLeft();
          $var_currency['symbol_right'] = $this->currency->getSymbolRight();
          $var_currency['decimals'] = $this->currency->getDecimalPlace();
          $var_currency['decimal_point'] = $this->language->get('decimal_point');
          $var_currency['thousand_point'] = $this->language->get('thousand_point');
          $data['currency'] = $var_currency;
          
          $data['dicounts_unf'] = $discounts;

          $data['tax_class_id'] = $product_info['tax_class_id'];
          $data['tax_rates'] = $this->tax->getRates(0, $product_info['tax_class_id']);
		  
          $data['config_display_qtyproduct'] = $this->config->get('config_display_qtyproduct');
          $data['config_display_kitoptions'] = $this->config->get('config_display_kitoptions');]]></add>
		</operation>
		<operation error="log">
			<search position="after"><![CDATA[$product_option_value_data[] = array(]]></search>
			<add><![CDATA['price_value_tax'               => $option_value['price'],
          'price_value'                   => $option_value['price'],
          'points_value'                  => intval($option_value['points_prefix'].$option_value['points']),]]></add>
		</operation>
		<!-- FIX
    <operation error="log">
      <search position="replace"><![CDATA[$option['type'] == 'select']]></search>
      <add><![CDATA[$option['type'] == 'select' || $option['type'] == 'checkbox_qty' || $option['type'] == 'radio_qty' || $option['type'] == 'select_qty']]></add>
    </operation>
	-->
	</file>
	<file name="catalog/view/theme/*/template/product/product.tpl">
		<operation error="log">
			<search position="before"><![CDATA[<?php if ($option['type'] == 'textarea') { ?>]]></search>
			<add><![CDATA[<script type="text/javascript"><!--
function price_format_sign(n)
{ 
    c = <?php echo (empty($currency['decimals']) ? "0" : $currency['decimals'] ); ?>;
    d = '<?php echo $currency['decimal_point']; ?>'; // decimal separator
    t = '<?php echo $currency['thousand_point']; ?>'; // thousands separator
    s_left = '<?php echo $currency['symbol_left']; ?>';
    s_right = '<?php echo $currency['symbol_right']; ?>';
      
    <?php // Process Tax Rates
      if (isset($tax_rates)) {
         foreach ($tax_rates as $tax_rate) {
           if ($tax_rate['type'] == 'F') {
             echo 'n += '.$tax_rate['rate'].';';
           } elseif ($tax_rate['type'] == 'P') {
             echo 'n += (n * '.$tax_rate['rate'].') / 100.0;';
           }
         }
      }
    ?>
    
    n = n * <?php echo $currency['value']; ?>;

    sign = (n < 0) ? '-' : '';

    //extracting the absolute value of the integer part of the number and converting to string
    i = parseInt(n = Math.abs(n).toFixed(c)) + ''; 

    j = ((j = i.length) > 3) ? j % 3 : 0; 
    return sign + s_left + (j ? i.substr(0, j) + t : '') + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : '') + s_right; 
}
//--></script>


        <?php if ($option['type'] == 'checkbox_qty') { ?>
        <div id="option-<?php echo $option['product_option_id']; ?>" class="option">
          <?php if ($option['required']) { ?>
          <span class="required">*</span>
          <?php } ?>
          <b><?php echo $option['name']; ?>:</b><br />
          
          <?php $id = $option['product_option_id']; ?>
          
<script type="text/javascript"><!--
function clean_<?php echo $id; ?>() {
    <?php foreach ($option['product_option_value'] as $option_value) { ?>
            $('#opt-qty-<?php echo $option_value['product_option_value_id']; ?>').val(1);
            $('#option-value-<?php echo $option_value['product_option_value_id']; ?>').removeAttr('checked');
    <?php } ?>
    calc_opt_<?php echo $id; ?>();
    if(typeof recalculateprice == 'function') {
        recalculateprice();
    }
}
function calc_opt_<?php echo $id; ?>() {
    var price = 0;
    $('#option-<?php echo $id; ?> input:checked').each(function() {
        if ($(this).attr('price_prefix') == '+') {
            price += Number($(this).attr('price'));
        } else if ($(this).attr('price_prefix') == '-') {
            price -= Number($(this).attr('price'));
        }
    });
    $('#result-<?php echo $id; ?>').html( price_format_sign(price) );
    if(typeof recalculateprice == 'function') {
        recalculateprice();
    }
}
//--></script>
          
                 <table  border=1 border-color=red cellspacing=0 cellpadding=0 
 style='border-collapse:collapse;border:1px solid #d4d4d4;'>

         
            <tr style="height:36px; background-color:#E7E7E7; text-align:center;">
            
                <th colspan="3" style="font-size:15px; font-weight:normal; border-color:#fff;padding:0 3px">Nome</th>
                <th style="font-size:15px; font-weight:normal; border-color:#fff;text-align:center">Qtd.</th>
                <th style="font-size:15px; font-weight:normal; border-color:#fff;text-align:center">Preço Un.
              </th>
            </tr>
          <?php foreach ($option['product_option_value'] as $option_value) { ?>
            <tr>
              <td width=30px; style="text-align:center; border-color:#E7E7E7;">
                <input type="checkbox" name="option[<?php echo $id; ?>][]" 
                       value="<?php echo $option_value['product_option_value_id']; ?>|1" id="option-value-<?php echo $option_value['product_option_value_id']; ?>" 
                       points="<?php echo $option_value['points_value']; ?>" price_prefix="<?php echo $option_value['price_prefix']; ?>" price="<?php printf("%.5f", $option_value['price_value_tax']); ?>"
                       onchange="calc_opt_<?php echo $id; ?>();"/>
              </td>
              
              <td style="text-align:center; border-color:#E7E7E7;">                  
             <label for="option-value-<?php echo $option_value['product_option_value_id']; ?>"><?php if ($option_value['image']) { ?><img src="<?php echo $option_value['image']; ?>" alt="<?php echo $option_value['name'] . ($option_value['price'] ? ' ' . $option_value['price_prefix'] . $option_value['price'] : ''); ?>" /><?php } ?></label>
              </td>

              <td width=200px; style="border-color:#E7E7E7;">                  
                 <span style="margin-left:10px;"> <label for="option-value-<?php echo $option_value['product_option_value_id']; ?>"><?php echo $option_value['name']; ?>
                 </span> </label>
              </td>
              
              
              <td width=80px; style="text-align:center; border-color:#E7E7E7;">
                <input type="number" min="1" name="" id="opt-qty-<?php echo $option_value['product_option_value_id']; ?>" value="1" oninput="$(this).attr('value', $(this).val()<1?1:$(this).val());
                   $('#option-value-<?php echo $option_value['product_option_value_id']; ?>').val( <?php echo $option_value['product_option_value_id']; ?> + '|' + Number($(this).attr('value')) );
                   $('#option-value-<?php echo $option_value['product_option_value_id']; ?>').attr('price', Number($(this).attr('price')) * Number($(this).attr('value')) );
                   calc_opt_<?php echo $id; ?>();
                " size="4" price="<?php echo $option_value['price_value_tax']; ?>" style="width: 40px;" /></td>
                
                <td width=100px; style="text-align:center;border-color:#E7E7E7;">
                <?php if ($option_value['price']) { ?>
                    <?php echo ($option_value['price']); ?>
                  <?php } ?>
                  </td>
                
            </tr>
          <?php } ?>
              <tr style="height:30px;">
                  <td colspan="3" style="text-align:left;border-color:#E7E7E7;"><button" class="btn btn-default btn-xs" style="padding:2px 5px;margin-left:3px" onclick="clean_<?php echo $id; ?>();"><i class="fa fa-refresh"></i></td>
                  <td style="text-align:center; border-color:#E7E7E7;" > Total: </td> <td style="text-align:center; border-color:#E7E7E7;" > <b><span id="result-<?php echo $id; ?>"> </span></b> </td>
              </tr>
          </table>
        </div>
        <br />
<script type="text/javascript"><!--
calc_opt_<?php echo $id; ?>();
//--></script>
        <?php } ?>
            
            
        <?php if ($option['type'] == 'radio_qty') { ?>
        <div id="option-<?php echo $option['product_option_id']; ?>" class="option">
          <?php if ($option['required']) { ?>
          <span class="required">*</span>
          <?php } ?>
          <b><?php echo $option['name']; ?>:</b><br />
          
          <?php $id = $option['product_option_id']; ?>
          
<script type="text/javascript"><!--
function clean_<?php echo $id; ?>() {
    <?php foreach ($option['product_option_value'] as $option_value) { ?>
            $('#opt-qty-<?php echo $option_value['product_option_value_id']; ?>').val(1);
            $('#option-value-<?php echo $option_value['product_option_value_id']; ?>').removeAttr('checked');
    <?php } ?>
    calc_opt_<?php echo $id; ?>();
    if(typeof recalculateprice == 'function') {
        recalculateprice();
    }
}
function calc_opt_<?php echo $id; ?>() {
    var price = 0;
    $('#option-<?php echo $id; ?> input:checked').each(function() {
        if ($(this).attr('price_prefix') == '+') {
            price += Number($(this).attr('price'));
        } else if ($(this).attr('price_prefix') == '-') {
            price -= Number($(this).attr('price'));
        }
    });
    $('#result-<?php echo $id; ?>').html( price_format_sign(price) );
    if(typeof recalculateprice == 'function') {
        recalculateprice();
    }
}
//--></script>
          
           <table  border=1 border-color=red cellspacing=0 cellpadding=0 
 style='border-collapse:collapse;border:1px solid #d4d4d4;'>

         
            <tr style="height:36px; background-color:#E7E7E7; text-align:center;">
            
                <th colspan="3" style="font-size:15px; font-weight:normal; border-color:#fff;padding:0 3px">Nome</th>
                <th style="font-size:15px; font-weight:normal; border-color:#fff;text-align:center">Qtd.</th>
                <th style="font-size:15px; font-weight:normal; border-color:#fff;text-align:center">Preço Un.
              </th>
            </tr>
          <?php foreach ($option['product_option_value'] as $option_value) { ?>
            <tr>
               <td width=30px; style="text-align:center; border-color:#E7E7E7;">
                <input type="radio" name="option[<?php echo $id; ?>]" 
                       value="<?php echo $option_value['product_option_value_id']; ?>|1" id="option-value-<?php echo $option_value['product_option_value_id']; ?>" 
                       points="<?php echo $option_value['points_value']; ?>" price_prefix="<?php echo $option_value['price_prefix']; ?>" price="<?php printf("%.5f", $option_value['price_value_tax']); ?>"
                       onchange="calc_opt_<?php echo $id; ?>();"/>
              </td>
              
              <td style="text-align:center; border-color:#E7E7E7;">                  
             <label for="option-value-<?php echo $option_value['product_option_value_id']; ?>"><?php if ($option_value['image']) { ?><img src="<?php echo $option_value['image']; ?>" alt="<?php echo $option_value['name'] . ($option_value['price'] ? ' ' . $option_value['price_prefix'] . $option_value['price'] : ''); ?>" /><?php } ?></label>
              </td>

              <td width=200px; style="border-color:#E7E7E7;">                  
                 <span style="margin-left:10px;"> <label for="option-value-<?php echo $option_value['product_option_value_id']; ?>"><?php echo $option_value['name']; ?>
                 </span> </label>
              </td>
              
             <td width=80px; style="text-align:center; border-color:#E7E7E7;">
                <input type="number" min="1" name="" id="opt-qty-<?php echo $option_value['product_option_value_id']; ?>" value="1" oninput="$(this).attr('value', $(this).val()<1?1:$(this).val());
                   $('#option-value-<?php echo $option_value['product_option_value_id']; ?>').val( <?php echo $option_value['product_option_value_id']; ?> + '|' + Number($(this).attr('value')) );
                   $('#option-value-<?php echo $option_value['product_option_value_id']; ?>').attr('checked', true); 
                   $('#option-value-<?php echo $option_value['product_option_value_id']; ?>').attr('price', Number($(this).attr('price')) * Number($(this).attr('value')) );
                   calc_opt_<?php echo $id; ?>();
                " size="4" price="<?php echo $option_value['price_value_tax']; ?>" style="width: 40px;" /></td>
             
             <td width=100px; style="text-align:center;border-color:#E7E7E7;">
                  <?php if ($option_value['price']) { ?>
                    (<?php echo ($option_value['price']); ?>)
                  <?php } ?>
                  </label>
              </td>
            </tr>
          <?php } ?>
               <tr style="height:30px;">
                  <td colspan="3" style="text-align:center;border-color:#E7E7E7;"><button" class="btn btn-default btn-xs" style="padding:2px 5px;margin-left:3px" onclick="clean_<?php echo $id; ?>();"><i class="fa fa-refresh"></i></td>
                  <td style="text-align:center; border-color:#E7E7E7;" > Total: </td> <td style="text-align:center; border-color:#E7E7E7;" > <b><span id="result-<?php echo $id; ?>"> </span></b> </td>
              </tr>
          </table>
        </div>
        <br />
<script type="text/javascript"><!--
calc_opt_<?php echo $id; ?>();
//--></script>
        <?php } ?>
            
            
        <?php if ($option['type'] == 'select_qty') { ?>
        <div id="option-<?php echo $option['product_option_id']; ?>" class="option">
          <?php if ($option['required']) { ?>
          <span class="required">*</span>
          <?php } ?>
          <b><?php echo $option['name']; ?>:</b><br />
          
          <?php $id = $option['product_option_id']; ?>
          
<script type="text/javascript"><!--
function clean_<?php echo $id; ?>() {
    $('#opt-qty-s-<?php echo $id; ?>').val(1);
    //<?php foreach ($option['product_option_value'] as $option_value) { ?>
    //        $('#option-value-<?php echo $option_value['product_option_value_id']; ?>').attr('price', 0 );
    //        $('#option-value-<?php echo $option_value['product_option_value_id']; ?>').val( <?php echo $option_value['product_option_value_id']; ?> + '|0');
    //<?php } ?>
        
    $('#opt-qty-select-<?php echo $id; ?>').attr('selected', 'selected');
        
    calc_opt_<?php echo $id; ?>();
    if(typeof recalculateprice == 'function') {
        recalculateprice();
    }
}
function calc_opt_<?php echo $id; ?>() {
    var price = 0;
    
    qty = $('#opt-qty-s-<?php echo $id; ?>').attr('value');
        
    <?php foreach ($option['product_option_value'] as $option_value) { ?>
            opt_price = $('#option-value-<?php echo $option_value['product_option_value_id']; ?>').attr('p');
            //    alert(opt_price);
            $('#option-value-<?php echo $option_value['product_option_value_id']; ?>').attr('price', Number(opt_price) * qty );
            $('#option-value-<?php echo $option_value['product_option_value_id']; ?>').val( <?php echo $option_value['product_option_value_id']; ?> + '|' + qty);
    <?php } ?>
        
    $('#option-<?php echo $id; ?> option:selected').each(function() {
        if ($(this).attr('price_prefix') == '+') {
            price += Number($(this).attr('price'));
        } else if ($(this).attr('price_prefix') == '-') {
            price -= Number($(this).attr('price'));
        }
    });
    $('#result-<?php echo $id; ?>').html( price_format_sign(price) );
    if(typeof recalculateprice == 'function') {
        recalculateprice();
    }
}
//--></script>

		<table  border=1 border-color=red cellspacing=0 cellpadding=0 
 style='border-collapse:collapse;border:1px solid #d4d4d4;'>

         
            <tr style="height:36px; background-color:#E7E7E7; text-align:center;">
            
               
                <th style="font-size:15px; font-weight:normal; border-color:#fff;padding:0 3px">Nome</th>
                <th style="font-size:15px; font-weight:normal; border-color:#fff;text-align:center">Qtd.</th>
                <th style="font-size:15px; font-weight:normal; border-color:#fff;text-align:center">Preço Un.
              </th>
            </tr>

         
          
           <tr>
              <td width=310px; height=40px; style="text-align:center; border-color:#E7E7E7;">
          
          <select onchange="calc_opt_<?php echo $id; ?>();" id="opt-qty-<?php echo $id; ?>" name="option[<?php echo $option['product_option_id']; ?>]">
            <option value="" p="0" price="0" price_prefix="+" id="opt-qty-select-<?php echo $id; ?>"><?php echo $text_select; ?></option>
            <?php foreach ($option['product_option_value'] as $option_value) { ?>
            <option id="option-value-<?php echo $option_value['product_option_value_id']; ?>" value="<?php echo $option_value['product_option_value_id']; ?>" price="<?php printf("%.5f", $option_value['price_value_tax']); ?>" p="<?php printf("%.5f", $option_value['price_value_tax']); ?>" price_prefix="<?php echo $option_value['price_prefix']; ?>"><?php echo $option_value['name']; ?>
            &nbsp;&nbsp;&nbsp;<?php if ($option_value['price']) { ?>
            <?php echo $option_value['price']; ?>
            <?php } ?>
            </option>
            <?php } ?>
          </select>
         </td>
       
        
              <td style="text-align:center; border-color:#E7E7E7;">  
           <input type="text" name="" id="opt-qty-s-<?php echo $id; ?>" value="1" oninput="calc_opt_<?php echo $id; ?>();" size="4" style="width: 40px;" /> 
          </td>
          
          <td width=100px; style="text-align:center;border-color:#E7E7E7;">
          </td>
            
         <tr style="height:30px;">
                  <td colspan="1" style="text-align:center;border-color:#E7E7E7;"><button" class="btn btn-default btn-xs" style="padding:2px 5px;margin-left:3px" onclick="clean_<?php echo $id; ?>();"><i class="fa fa-refresh"></i></button></td>
                  <td style="text-align:center; border-color:#E7E7E7;" > Total: </td> <td style="text-align:center; border-color:#E7E7E7;" > <b><span id="result-<?php echo $id; ?>"> </span></b> </td>
              </tr>
          </table>
<script type="text/javascript"><!--
calc_opt_<?php echo $id; ?>();
//--></script>
         <br />
        <?php } ?>]]></add>
		</operation>
		<operation error="log">
			<search position="replace"><![CDATA[<span class="price-old"><?php echo $price; ?></span>]]></search>
			<add><![CDATA[<span id="formated_price" class="price-old" price="<?php echo $price_value; ?>"><?php echo $price; /**/ ?></span>]]></add>
		</operation>
		<operation error="log">
			<search position="replace"><![CDATA[<?php echo $special; ?>]]></search>
			<add><![CDATA[<span id="formated_special" price="<?php echo $special_value; ?>"><?php echo $special; /**/ ?></span>]]></add>
		</operation>
		<operation error="log">
			<search position="replace"><![CDATA[<?php echo $price; ?>]]></search>
			<add><![CDATA[<span id="formated_price" price="<?php echo $price_value; ?>"><?php echo $price; ?></span>]]></add>
		</operation>
		<!--  prices without VAT -->
		<operation error="log">
			<search position="replace"><![CDATA[<?php echo $tax; ?>]]></search>
			<add><![CDATA[<span id="formated_tax" price="<?php echo $tax_value; ?>"><?php echo $tax; ?></span>]]></add>
		</operation>
		<operation error="log">
			<search position="replace"><![CDATA[<select name="option[<?php echo $option['product_option_id']; ?>]"]]></search>
			<add><![CDATA[<select id="options-<?php echo $option['product_option_id']; ?>" name="option[<?php echo $option['product_option_id']; ?>]" onchange="recalculateprice();"]]></add>
		</operation>
		<operation error="log">
			<!-- FIX -->
			<search position="after"><![CDATA[<div id="product">]]></search>
			<add><![CDATA[<div class="options" id="product_options">]]></add>
		</operation>
		<operation error="log">
			<search position="replace"><![CDATA[<option value="<?php echo $option_value['product_option_value_id']; ?>"><?php echo $option_value['name']; ?>]]></search>
			<add><![CDATA[<option value="<?php echo $option_value['product_option_value_id']; ?>"  points="<?php echo $option_value['points_value']; ?>" price_prefix="<?php echo $option_value['price_prefix']; ?>" price="<?php echo $option_value['price_value']; ?>"><?php echo $option_value['name']; ?>]]></add>
		</operation>
		<operation error="log">
			<search position="before"><![CDATA[<?php foreach ($option['product_option_value'] as $option_value) { ?>]]></search>
			<add><![CDATA[<?php $opt_checked="checked"; ?>]]></add>
		</operation>
		<operation error="log">
			<search position="replace"><![CDATA[<input type="radio" name="option[<?php echo $option['product_option_id']; ?>]" value="<?php echo $option_value['product_option_value_id']; ?>" />]]></search>
			<add><![CDATA[<input type="radio" name="option[<?php echo $option['product_option_id']; ?>]" value="<?php echo $option_value['product_option_value_id']; ?>" points="<?php echo $option_value['points_value']; ?>" price_prefix="<?php echo $option_value['price_prefix']; ?>" price="<?php echo $option_value['price_value']; ?>" id="option-value-<?php echo $option_value['product_option_value_id']; ?>" <?php echo $opt_checked; $opt_checked=""; ?> onchange="recalculateprice();" />]]></add>
		</operation>
		<operation error="log">
			<search position="replace"><![CDATA[<input type="checkbox" name="option[<?php echo $option['product_option_id']; ?>][]" value="<?php echo $option_value['product_option_value_id']; ?>" />]]></search>
			<add><![CDATA[<input type="checkbox" name="option[<?php echo $option['product_option_id']; ?>][]" value="<?php echo $option_value['product_option_value_id']; ?>" points="<?php echo $option_value['points_value']; ?>" price_prefix="<?php echo $option_value['price_prefix']; ?>" price="<?php printf("%.5f", $option_value['price_value']); ?>" id="option-value-<?php echo $option_value['product_option_value_id']; ?>" onchange="recalculateprice();" />]]></add>
		</operation>
		<operation error="log">
			<search position="replace"><![CDATA[<option value=""><?php echo $text_select; ?></option>]]></search>
			<add><![CDATA[<option value=""  price_prefix="+" price="0.0"><?php echo $text_select; ?></option>]]></add>
		</operation>
		<!--
    <operation error="log">
      <search position="replace"><![CDATA[name="quantity"]]></search>
      <add><![CDATA[name="quantity" id="product_buy_quantity" oninput="recalculateprice();" ]]></add>
    </operation>
  -->
		<!-- points -->
		<operation error="log">
			<search position="replace"><![CDATA[<?php echo $points; ?>]]></search>
			<add><![CDATA[<span id="formated_points" points="<?php echo $points; /**/ ?>"><?php echo $points; /**/ ?></span>]]></add>
		</operation>
		<!-- Multiply Options -->
		<operation error="log">
			<search position="replace"><![CDATA[(<?php echo $option_value['price_prefix']; ?><?php echo $option_value['price']; ?>)]]></search>
			<add><![CDATA[<?php
          if ($option_value['price_prefix'] == '*') {
            if ($option_value['price_value'] != 1.0)
              printf("(%+d%%)", ($option_value['price_value'] * 100) - 100 );
          } else {
            echo "(".$option_value['price_prefix'].$option_value['price'].")"; 
          }
          ?>]]></add>
		</operation>
		<operation error="log">
			<search position="before"><![CDATA[<?php echo $footer; ?>]]></search>
			<add><![CDATA[<script type="text/javascript"><!--

function price_format(n)
{ 
    c = <?php echo (empty($currency['decimals']) ? "0" : $currency['decimals'] ); ?>;
    d = '<?php echo $currency['decimal_point']; ?>'; // decimal separator
    t = '<?php echo $currency['thousand_point']; ?>'; // thousands separator
    s_left = '<?php echo $currency['symbol_left']; ?>';
    s_right = '<?php echo $currency['symbol_right']; ?>';
      
    n = n * <?php echo $currency['value']; ?>;

    //sign = (n < 0) ? '-' : '';

    //extracting the absolute value of the integer part of the number and converting to string
    i = parseInt(n = Math.abs(n).toFixed(c)) + ''; 

    j = ((j = i.length) > 3) ? j % 3 : 0; 
    return s_left + (j ? i.substr(0, j) + t : '') + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : '') + s_right; 
}

function calculate_tax(price)
{
    <?php // Process Tax Rates
      if (isset($tax_rates)) {
         foreach ($tax_rates as $tax_rate) {
           if ($tax_rate['type'] == 'F') {
             echo 'price += '.$tax_rate['rate'].';';
           } elseif ($tax_rate['type'] == 'P') {
             echo 'price += (price * '.$tax_rate['rate'].') / 100.0;';
           }
         }
      }
    ?>
    return price;
}

function process_discounts(price, quantity)
{
    <?php
      foreach ($dicounts_unf as $discount) {
        echo 'if ((quantity >= '.$discount['quantity'].') && ('.$discount['price'].' < price)) price = '.$discount['price'].';'."\n";
      }
    ?>
    return price;
}

function recalculateprice()
{
    var main_price = Number($('#formated_price').attr('price'));
    var input_quantity = Number($('#product_buy_quantity').attr('value'));
    var special = Number($('#formated_special').attr('price'));
    var tax = Number($('#formated_tax').attr('price'));
    
    // Process Discounts.
    main_price = process_discounts(main_price, input_quantity);
    tax = process_discounts(tax, input_quantity);
    
    
   <?php if ($points) { ?>
     var points = Number($('#formated_points').attr('points'));
     $('#product_options input:checked').each(function() {
       points += Number($(this).attr('points'));
     });
     $('#product_options option:selected').each(function() {
       points += Number($(this).attr('points'));
     });
     $('#formated_points').html(points);
   <?php } ?>
    
    
    $('#product_options input:checked,option:selected').each(function() {
      if ($(this).attr('price_prefix') == '=') {
        main_price = Number($(this).attr('price'));
        special = main_price;
        tax = main_price;
      }
    });
    
    $('#product_options input:checked,option:selected').each(function() {
      if ($(this).attr('price_prefix') == '+') {
        main_price += Number($(this).attr('price'));
        special += Number($(this).attr('price'));
        tax += Number($(this).attr('price'));
      }
      if ($(this).attr('price_prefix') == '-') {
        main_price -= Number($(this).attr('price'));
        special -= Number($(this).attr('price'));
        tax -= Number($(this).attr('price'));
      }
      if ($(this).attr('price_prefix') == '*') {
        main_price = main_price * Number($(this).attr('price'));
        special = special * Number($(this).attr('price'));
        tax = tax * Number($(this).attr('price'));
      }
    });

    // Process TAX.
    main_price = calculate_tax(main_price);
    special = calculate_tax(special);
    
    // Display Main Price
    $('#formated_price').html( price_format(main_price) );
      
    <?php if ($special) { ?>
      $('#formated_special').html( price_format(special) );
    <?php } ?>

    <?php if ($tax) { ?>
      $('#formated_tax').html( price_format(tax) );
    <?php } ?>
}

recalculateprice();

//--></script>]]></add>
		</operation>
		<operation error="log">
			<search position="replace" offset="1"><![CDATA[<label class="control-label" for="input-quantity"><?php echo $entry_qty; ?></label>]]></search>
			<add><![CDATA[<?php if ($config_display_qtyproduct=='1')  { ?> 
		  <label class="control-label" for="input-quantity"><?php echo $entry_qty; ?></label>
          <input type="text" name="quantity" value="<?php echo $minimum; ?>" size="2" id="input-quantity" class="form-control" />

           <?php }  else ?>
        <?php if ($config_display_kitoptions=='0')  { ?> 
        
       
    
        
         <?php } ?>]]></add>
		</operation>
	</file>
	<!-- +++++++  Enable/Disable Product Quantity  ++++++  -->
	<file name="admin/controller/setting/setting.php">
		<operation error="log">
			<search position="before" error="log"><![CDATA[if (isset($this->request->post['config_logo'])) {]]></search>
			<add><![CDATA[//Super Options Mode Settings
		
		if (isset($this->request->post['config_display_qtyproduct'])) {
			$data['config_display_qtyproduct'] = $this->request->post['config_display_qtyproduct'];
		} else {
			$data['config_display_qtyproduct'] = $this->config->get('config_display_qtyproduct');
		}]]></add>
		</operation>
	</file>
	<file name="admin/view/template/setting/setting.tpl">
		<operation error="log">
			<search position="after" offset="2"><![CDATA[<div class="tab-pane" id="tab-option">]]></search>
			<add><![CDATA[<div class="form-group">
					<label class="col-sm-2 control-label">Campo "Quantidade"</label>
					<div class="col-sm-10">
						<select name="config_display_qtyproduct" class="form-control">
							<?php if ($config_display_qtyproduct) { ?>
								<option value="1" selected="selected"><?php echo $text_enabled; ?></option>
								<option value="0"><?php echo $text_disabled; ?></option>
							<?php } else { ?>
								<option value="1"><?php echo $text_enabled; ?></option>
								<option value="0" selected="selected"><?php echo $text_disabled; ?></option>
							<?php } ?>
						</select>
					</div>
                </div>]]></add>
		</operation>
	</file>
</modification>